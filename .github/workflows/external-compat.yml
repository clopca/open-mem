name: external-compat

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:
    inputs:
      claude_code_version:
        description: "Claude Code version under test"
        required: false
        default: "unknown"
      cursor_version:
        description: "Cursor version under test"
        required: false
        default: "unknown"

jobs:
  verify:
    runs-on: [self-hosted, macOS]
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Install
        run: bun install
      - name: Build
        run: bun run build
      - name: Verify external clients
        env:
          OPEN_MEM_CLAUDE_CODE_VERSION: ${{ inputs.claude_code_version }}
          OPEN_MEM_CURSOR_VERSION: ${{ inputs.cursor_version }}
        run: bun run compat:verify --artifacts-dir .artifacts/external-compat
      - name: Render compatibility matrix snapshot
        run: |
          bun run compat:matrix --report .artifacts/external-compat/external-compat-report.json --matrix docs/mcp-compatibility-matrix.md
          cp docs/mcp-compatibility-matrix.md .artifacts/external-compat/mcp-compatibility-matrix.md
      - name: Smoke worker lifecycle/bridge
        run: bun run compat:smoke --artifacts-dir .artifacts/external-compat
      - name: Build artifact bundle
        run: |
          cd .artifacts
          zip -r external-compat-${{ github.run_id }}.zip external-compat
      - name: Upload artifact bundle
        uses: actions/upload-artifact@v4
        with:
          name: external-compat-${{ github.run_id }}
          path: .artifacts/external-compat-${{ github.run_id }}.zip
          if-no-files-found: error
